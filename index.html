<html>
<head>
    <link rel="stylesheet" href="styles.css" type="text/css"/>
</head>
<body>
<div id="container">
    <div>
        <label for="schema">Schema</label>
        <select onchange="updateTextAreas()" id="schemaSelector"></select><br/>
        <textarea rows="20" cols="50" id="schema"></textarea><br/>
    </div>
    <div>
        <label for="data">Data</label><br/>
        <textarea rows="20" cols="50" id="data"></textarea>
    </div>
</div>
<button onclick="validate()">Validate!</button>
<div id="output"></div>
</body>

<script src="tv4.js"></script>
<script src="contracts.js"></script>
<script>
    function validate() {
        try {
            const schema = JSON.parse(document.querySelector('#schema').value.trim());
            const data = JSON.parse(document.querySelector('#data').value.trim());
            const validation = tv4.validateMultiple(data, schema);

            const message = validation.errors.length ? makeMessage(validation, data) : 'No errors! Good job!';
            showMessage(message);
        } catch (error) {
            showError(error);
        }
    }

    function showMessage(message, color) {
        const output = document.querySelector('#output');
        output.style.color = color || 'black';
        output.innerHTML = message;
    }

    function showError(message) {
        showMessage(message, 'red');
    }

    function updateTextAreas() {
        const key = document.querySelector('#schemaSelector').value;
        document.querySelector('#schema').value = JSON.stringify(contracts[key].schema, null, 2);
        document.querySelector('#data').value = JSON.stringify(contracts[key].example, null, 2);
    }

    function updateDropdown() {
        const select = document.querySelector('#schemaSelector');
        for (const key in contracts) {
            const option = document.createElement('option');
            option.value = key;
            option.text = key;
            select.append(option);
        }
    }

    function makeMessage(validation, data) {
        return validation.errors
            .map(error => {
                const snippet = getSnippet(data, error.dataPath);
                return `<strong>${error.dataPath}</strong>: ${error.message}<br/>at <span class="snippet">${snippet}</span><br/><br/>`
            })
            .join('')
    }

    function getSnippet(data, jsonPath) {
        const paths = jsonPath.substring(1).split('/');
        const key = paths.pop();

        let snippet = data;
        paths.forEach(path => snippet = snippet[path]);

        const string = JSON.stringify(snippet, null, 2);
        return string.replace(`"${key}":`, `<strong class="louder">"${key}":</strong>`);
    }

    updateDropdown();
    updateTextAreas();
</script>
</html>
